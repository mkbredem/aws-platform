---
- name: Provision instance in AWS
  hosts: localhost
  gather_facts: false
# vars: defaults in group_vars/all/aws_vars.yml


  tasks:
############## Series of checks to determine         ##################
############## which flavor of OS was selected       ##################
############## so the propper provisioning           ##################
############## and subsequent configuration process  ##################
############## is followed.                          ##################

    - name: Conditionally provision Windows ec2 instance in AWS
      when: image_name is match("win*")
      amazon.aws.ec2_instance:
        region: "{{ aws_region }}"
        state: started
        key_name: "{{ ssh_key_name }}"
        security_group: "{{ aws_vpcs[vpc_number]['aws_security_group_id'] }}"
        instance_type: "{{ instance_size }}"
        tags: 
          Env: "{{ env_tag }}"
          App: "{{ app_tag }}"
          Name: "{{ name_tag }}"
        image_id: "{{ ami_id[aws_region][image_name] }}"
        wait: true
        vpc_subnet_id: "{{ aws_vpcs[vpc_number]['aws_subnet_id'] }}"
        count: "{{ instance_count }}"
        network:
          assign_public_ip: yes
        user_data: | 
          <powershell>
          $admin = [adsi]("WinNT://./administrator, user")
          $admin.PSBase.Invoke("SetPassword", "myTempPassword123!")
          Invoke-Expression ((New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1'))
          </powershell>
      register: ec2_instance_facts_win
      
    - name: Conditionally provision RHEL ec2 instance in AWS
      when: image_name is match("rhel*")
      amazon.aws.ec2_instance:
        region: "{{ aws_region }}"
        count: "{{ instance_count }}"
        state: started
        key_name: "{{ ssh_key_name }}"
        security_group: "{{ aws_vpcs[vpc_number]['aws_security_group_id'] }}"
        instance_type: "{{ instance_size }}"
        volumes:
          - device_name: /dev/xvda
            ebs:
              volume_size: 40
              delete_on_termination: true
        tags: 
          Env: "{{ env_tag }}"
          App: "{{ app_tag }}"
          Name: "{{ name_tag }}"
        image_id: "{{ ami_id[aws_region][image_name] }}"
        wait: true
        vpc_subnet_id: "{{ aws_vpcs[vpc_number]['aws_subnet_id'] }}"
        network:
          assign_public_ip: yes
      register: ec2_instance_facts_rhel      

    - name: Conditionally provision Fedora ec2 instance in AWS
      when: image_name is match("fed*")
      amazon.aws.ec2_instance:
        region: "{{ aws_region }}"
        # count: "{{ instance_count }}"
        state: started
        key_name: "{{ ssh_key_name }}"
        security_group: "{{ aws_vpcs[vpc_number]['aws_security_group_id'] }}"
        instance_type: "{{ instance_size }}"
        tags: 
          Env: "{{ env_tag }}"
          App: "{{ app_tag }}"
          Name: "{{ name_tag }}"
        image_id: "{{ ami_id[aws_region][image_name] }}"
        wait: true
        vpc_subnet_id: "{{ aws_vpcs[vpc_number]['aws_subnet_id'] }}"
        network:
          assign_public_ip: yes
      register: ec2_instance_facts_fed

###########                                 #############
###########                                 #############
########### End of conditional provisioning #############
###########                                 #############
###########                                 #############

    - name: initialize target_hosts as an empty list/array
      set_fact:
        target_hosts: []

    - name: load Windows instances into target_hosts list (used in future plays for config)
      when: image_name == "windows2019" 
      set_stats:
        data: 
          target_hosts: "{{ target_hosts + [ item.public_dns_name ] }}"
      loop: "{{ ec2_instance_facts_win.instances }}"

    - name: load RHEL instances into target_hosts list (used in future plays for config)
      when: image_name is match("rhel*")
      set_stats:
        data: 
          target_hosts: "{{ target_hosts + [ item.public_dns_name ] }}"
      loop: "{{ ec2_instance_facts_rhel.instances }}"

    - name: give instance time to initialize before configuration
      ansible.builtin.wait_for: 
        timeout: 150



